name: Dependency Updates

on:
  schedule:
    - cron: '0 0 * * MON' # Weekly on Monday at midnight
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.14.1'

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Update dependencies
        run: |
          pnpm update --interactive false
          pnpm audit --fix || true
      
      - name: Check for better-auth updates
        id: check-updates
        run: |
          cd vendor/better-auth
          git fetch origin
          CURRENT_COMMIT=$(git rev-parse HEAD)
          LATEST_COMMIT=$(git rev-parse origin/main)
          
          if [ "$CURRENT_COMMIT" != "$LATEST_COMMIT" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
            echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Update better-auth submodule
        if: steps.check-updates.outputs.update_available == 'true'
        run: |
          cd vendor/better-auth
          git checkout main
          git pull origin main
          cd ../..
          git add vendor/better-auth
      
      - name: Run compatibility check
        if: steps.check-updates.outputs.update_available == 'true'
        run: pnpm run compatibility:check
        continue-on-error: true
      
      - name: Build and test
        run: |
          pnpm install
          pnpm run build
          pnpm test
        continue-on-error: true
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies and better-auth submodule'
          title: '🔄 Weekly Dependency Updates'
          body: |
            ## Dependency Updates
            
            This PR contains automated dependency updates including:
            - npm package updates
            - Security vulnerability fixes
            - Better-auth submodule updates (if available)
            
            ### Better-Auth Update Status
            ${{ steps.check-updates.outputs.update_available == 'true' && '✅ New better-auth version available' || '✔️ Better-auth is up to date' }}
            
            ### Actions Required
            1. Review the changes
            2. Check compatibility test results
            3. Verify build and test status
            4. Merge if all checks pass
            
            ---
            *This PR was automatically generated by the dependency update workflow.*
          branch: deps/weekly-update
          delete-branch: true
          labels: |
            dependencies
            automated